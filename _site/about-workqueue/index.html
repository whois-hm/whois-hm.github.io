<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/BlogPosting" class="post-wq">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>About  Workqueue</title>
    <meta name="description" content="Description Repository 'workqueue'">

    <!-- Google Authorship Markup -->
    <link rel="author" href="https://plus.google.com/+?rel=author">

    <!-- Social: Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@">
    <meta name="twitter:title" content="About  Workqueue">
    <meta name="twitter:description" content="Description Repository 'workqueue'">
    
    <meta property="twitter:image:src" content="http://localhost:4000/assets/img/">
    

    <!-- Social: Facebook / Open Graph -->
    <meta property="og:url" content="http://localhost:4000/about-workqueue/">
    <meta property="og:title" content="About  Workqueue">
    
    <meta property="og:image" content="http://localhost:4000/assets/img/">
    
    <meta property="og:description" content="Description Repository 'workqueue'">
    <meta property="og:site_name" content="API Document">

    <!-- Social: Google+ / Schema.org  -->
    <meta itemprop="name" content="About  Workqueue"/>
    <meta itemprop="description" content="Description Repository 'workqueue'">
    <meta itemprop="image" content="http://localhost:4000/assets/img/blog-image.png"/>

    <!-- Favicon -->
    <link rel="shortcut icon" href="/assets/img/icons/favicon.ico" type="image/x-icon" />
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/assets/img/icons/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/img/icons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/img/icons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/icons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/img/icons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/img/icons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/img/icons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/icons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/img/icons/apple-touch-icon-152x152.png" />
    <!-- Windows 8 Tile Icons -->
    <meta name="application-name" content="hmkwon Blog">
    <meta name="msapplication-TileColor" content="#0562DC">
    <meta name="msapplication-square70x70logo" content="smalltile.png" />
    <meta name="msapplication-square150x150logo" content="mediumtile.png" />
    <meta name="msapplication-wide310x150logo" content="widetile.png" />
    <meta name="msapplication-square310x310logo" content="largetile.png" />
    <!-- Android Lolipop Theme Color -->
    <meta name="theme-color" content="#B31917">

    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="http://localhost:4000/about-workqueue/">
    <link rel="alternate" type="application/rss+xml" title="API Document" href="http://localhost:4000/feed.xml" />
</head>

    <body>
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" display="none" version="1.1"><defs><symbol id="icon-menu" viewBox="0 0 1024 1024"><path class="path1" d="M128 213.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 725.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 469.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5z"/></symbol><symbol id="icon-search" viewBox="0 0 951 1024"><path class="path1" d="M658.286 475.429q0-105.714-75.143-180.857t-180.857-75.143-180.857 75.143-75.143 180.857 75.143 180.857 180.857 75.143 180.857-75.143 75.143-180.857zM950.857 950.857q0 29.714-21.714 51.429t-51.429 21.714q-30.857 0-51.429-21.714l-196-195.429q-102.286 70.857-228 70.857-81.714 0-156.286-31.714t-128.571-85.714-85.714-128.571-31.714-156.286 31.714-156.286 85.714-128.571 128.571-85.714 156.286-31.714 156.286 31.714 128.571 85.714 85.714 128.571 31.714 156.286q0 125.714-70.857 228l196 196q21.143 21.143 21.143 51.429z"/></symbol><symbol id="icon-close" viewBox="0 0 805 1024"><path class="path1" d="M741.714 755.429q0 22.857-16 38.857l-77.714 77.714q-16 16-38.857 16t-38.857-16l-168-168-168 168q-16 16-38.857 16t-38.857-16l-77.714-77.714q-16-16-16-38.857t16-38.857l168-168-168-168q-16-16-16-38.857t16-38.857l77.714-77.714q16-16 38.857-16t38.857 16l168 168 168-168q16-16 38.857-16t38.857 16l77.714 77.714q16 16 16 38.857t-16 38.857l-168 168 168 168q16 16 16 38.857z"/></symbol><symbol id="icon-twitter" viewBox="0 0 951 1024"><path class="path1" d="M925.714 233.143q-38.286 56-92.571 95.429 0.571 8 0.571 24 0 74.286-21.714 148.286t-66 142-105.429 120.286-147.429 83.429-184.571 31.143q-154.857 0-283.429-82.857 20 2.286 44.571 2.286 128.571 0 229.143-78.857-60-1.143-107.429-36.857t-65.143-91.143q18.857 2.857 34.857 2.857 24.571 0 48.571-6.286-64-13.143-106-63.714t-42-117.429v-2.286q38.857 21.714 83.429 23.429-37.714-25.143-60-65.714t-22.286-88q0-50.286 25.143-93.143 69.143 85.143 168.286 136.286t212.286 56.857q-4.571-21.714-4.571-42.286 0-76.571 54-130.571t130.571-54q80 0 134.857 58.286 62.286-12 117.143-44.571-21.143 65.714-81.143 101.714 53.143-5.714 106.286-28.571z"/></symbol><symbol id="icon-facebook" viewBox="0 0 585 1024"><path class="path1" d="M548 6.857v150.857h-89.714q-49.143 0-66.286 20.571t-17.143 61.714v108h167.429l-22.286 169.143h-145.143v433.714h-174.857v-433.714h-145.714v-169.143h145.714v-124.571q0-106.286 59.429-164.857t158.286-58.571q84 0 130.286 6.857z"/></symbol><symbol id="icon-google-plus" viewBox="0 0 951 1024"><path class="path1" d="M420 454.857q0 20.571 18.286 40.286t44.286 38.857 51.714 42 44 59.429 18.286 81.143q0 51.429-27.429 98.857-41.143 69.714-120.571 102.571t-170.286 32.857q-75.429 0-140.857-23.714t-98-78.571q-21.143-34.286-21.143-74.857 0-46.286 25.429-85.714t67.714-65.714q74.857-46.857 230.857-57.143-18.286-24-27.143-42.286t-8.857-41.714q0-20.571 12-48.571-26.286 2.286-38.857 2.286-84.571 0-142.571-55.143t-58-139.714q0-46.857 20.571-90.857t56.571-74.857q44-37.714 104.286-56t124.286-18.286h238.857l-78.857 50.286h-74.857q42.286 36 64 76t21.714 91.429q0 41.143-14 74t-33.714 53.143-39.714 37.143-34 35.143-14 37.714zM336.571 400q21.714 0 44.571-9.429t37.714-24.857q30.286-32.571 30.286-90.857 0-33.143-9.714-71.429t-27.714-74-48.286-59.143-66.857-23.429q-24 0-47.143 11.143t-37.429 30q-26.857 33.714-26.857 91.429 0 26.286 5.714 55.714t18 58.857 29.714 52.857 42.857 38.286 55.143 14.857zM337.714 898.857q33.143 0 63.714-7.429t56.571-22.286 41.714-41.714 15.714-62.286q0-14.286-4-28t-8.286-24-15.429-23.714-16.857-20-22-19.714-20.857-16.571-23.714-17.143-20.857-14.857q-9.143-1.143-27.429-1.143-30.286 0-60 4t-61.429 14.286-55.429 26.286-39.143 42.571-15.429 60.286q0 40 20 70.571t52.286 47.429 68 25.143 72.857 8.286zM800.571 398.286h121.714v61.714h-121.714v125.143h-60v-125.143h-121.143v-61.714h121.143v-124h60v124z"/></symbol></defs></svg>

        <header class="bar-header">
    <h1 class="logo">
        <a href="/"></a>
    </h1>
</header>
<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search...">
        <svg class="icon-remove-sign"><use xlink:href="#icon-close"></use></svg>
        <ul class="search-results search-list"></ul>
    </div>
</div>

<div id="fade" class="overlay"></div>
<a id="slide" class="slideButton fade">
    <svg id="open" class="icon-menu"><use xlink:href="#icon-menu"></use></svg>
    <svg id="close" class="icon-menu"><use xlink:href="#icon-close"></use></svg>
</a>
<aside id="sidebar">
<nav id="navigation">
  <h2>MENU</h2>
 
  <ul>
    
    	
	      <li><a href="http://localhost:4000/">Home</a></li>
	     
    
    	
	      <li><a href="http://localhost:4000/series">Series</a></li>
	     
    
    	
    
    	
	      <li><a href="http://localhost:4000/about">About Me</a></li>
	     
    
    <!--
    <li><a class="feed" href="http://localhost:4000/feed.xml" title="Atom/RSS feed">Feed</a></li>
    -->
  </ul>

</nav>
</aside>
<a id="search" class="dosearch">
    <svg class="icon-menu icon-search"><use xlink:href="#icon-search"></use></svg>
</a>

<header class="header-post" role="banner">
     <div class="content">
        
            <time itemprop="datePublished" datetime="2020-04-21T00:00:00+09:00" class="date">21 Apr 2020</time>
        
        <h1 class="post-title" itemprop="name">About  Workqueue</h1>
        <p itemprop="description" class="subtitle">Description Repository 'workqueue'</p>
    </div>
</header>
        <section class="post">

            <article role="article" id="post" class="post-content" itemprop="articleBody">
                <h2 id="1-thread">#1 Thread</h2>
<p>Process를 설계하다보면, 실시간처리, Blocking I/O처리,  단일Context등의 관리를 위해 
Thread를 사용한 병렬처리를 요구하는 경우가 발생한다.</p>

<blockquote>
  <p>Thread가 요구되는 간단한 예</p>
</blockquote>

<p><img src="../images/audiofile_speaker.png" alt="audiofile_speaker" /></p>

<p>프로그램이 구동되면 하나의 오디오 파일에서 2개의 출력 장치로 
Sound를 출력하는 아래의 예시 코드를 보자</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++">    <span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
     <span class="n">open_file</span><span class="p">();</span>      
     <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">end_file</span><span class="p">())</span>
     <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">();</span>
      <span class="n">write_audio1</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
      <span class="n">write_audio2</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
     <span class="p">}</span>
    <span class="p">}</span></code></pre></figure>

<p>진입점에서 오디오파일을 열고 파일의 데이터를 전부 읽을때까지 while루프 안에서 
1번, 2번 audio 출력장치로 data를 내보내는 코드이다.</p>

<h3 id="여기서-발생할수-있는-문제점은-무엇일까">여기서 발생할수 있는 문제점은 무엇일까?</h3>

<p>문제 발생지점은 write_audio1(data);, write_audio2(data); 부분이다. 
항상 1번 출력을 완료한후 2번을 출력하고, 다시 2번 출력을 완료한후 1번출력을 수행하기 때문에
개별 출력 관점에서 볼때 음단절이 발생할 확률이 크다.
예시에서는 단2개의 출력이지만 n개의, 즉 출력 장치가 많아 질수록 위 문제점은 더 부각될것이다.</p>

<h3 id="해결-방법은">해결 방법은?</h3>

<p>write_audio 수행을 병렬로 처리하는것이다. 
각자의 출력장치가 다른 출력장치의 결과가 반환되기를 기다린후 동작하는 것이 아닌 
각자의 Thread에서 개별적으로 출력하는것이다.</p>

<blockquote>
  <p><em>(Thead로  분리한다해도 단일 코어등 Spec이 낮은 하드웨어에선 동일한 결과가 발생할것이라 생각될수 있지만,
Cpu는 데이터를 Bus를 통해 장치로 내보내는 I/O작업 과정에서 또는 기타I/O등에서 Context Switching을 발생시키기 때문에 
단일 Thread에서 작업되는 내용보다 더욱 효율적이다.)</em></p>
</blockquote>

<p>‘각자의 Thread에서 개별적으로 출력하는것’은 여러 구조설계방안과 단순 Thread처리가 가능하지만 
여기서는 #2의 Workqueue를 기반한 구조설계방안으로 접근할것이다. 
먼저 #2 정의를 살펴보고 #3에서 실제 적용예시를 살펴보자</p>

<h2 id="2-workqueue">#2 Workqueue</h2>

<p>Workqueue는 Event 송/수신을 통해 기존의 Function Call에 기반한 프로그래밍이 아닌
Event 기반의 Thread프로그래밍을 가능하게한다. 
생성한 Thread를 Event를 요청하는 ‘요청자’와 수신된 Event를 처리하는 ‘수신자’로 분리하며,
<img src="../images/wq_1.png" alt="wq_1" /></p>
<center>(요청자임과 동시에 수신자가 될수있으며, 반대의 경우도 동일하다)</center>
<p><br />
	<br />
Naming에서도 알 수 있듯이 Queue에 기반하여 Event를 송/수신하고,  때문에 별도의 CriticalSection구역을 
지정 하지 않아도 원자적인 Data 처리가 가능하다.
<img src="../images/wq_5.png" alt="wq_5" /></p>

<p>요청자는 Blocking Mode 또는 None Blocking Mode로 수신자에게 Event 전달 할 수 있기 때문에
단순 Event전달 요청으로 수행을 완료할수도 필요에 따라 수신 Thread의 Event수행결과를 반환받고 
수행을 완료할 수도있다. 
<img src="../images/wq_2.png" alt="wq_2" /></p>
<center>(None Block Mode)</center>
<p><img src="../images/wq_3.png" alt="wq_3" /></p>
<center>(Block Mode)</center>
<p><br />
	<br />
수신자는 자신의 EventQueue를 감시하며 외부 요청에의한 Event Trigger시 해당 요청을 수행한다. 
EventQueue를 감시함에 있어서 Cpu자원을 소비하지 않기 때문에 다른 Thread의 동작에 영향을 주지 않고
Sleep하는것이 가능하고 Timeout을 설정할수 있기때문에 자신만의 Scheduling을 가져갈수있다. 
<img src="../images/wq_4.png" alt="wq_4" /> 
<br />
<br /></p>
<blockquote>
  <p>간단히 요약하면 Thread간의 Communication 도구 이다.</p>
</blockquote>

<h2 id="3-apply-to">#3 Apply to</h2>
<p>이제 #1의 개선방안을 #2를 기반으로 구조설계를 변경해 보자.
먼저의생각해볼점은
<br /></p>
<ol>
  <li>Thread 구성?</li>
  <li>Thread Stack 생성된 출력장치의 Meta data관리?</li>
  <li>파일Instance를 2개의 Thread에서 접근한다?</li>
  <li>Thread BusyLock?</li>
  <li>출력장치와의 Interface?</li>
</ol>

<h3 id="workqueue를-기반하면-위의-생각해볼-사항들을-다음과-같이-정리할-수-있다">Workqueue를 기반하면 위의 생각해볼 사항들을 다음과 같이 정리할 수 있다.</h3>

<blockquote>
  <p>Thread 구성?</p>
</blockquote>

<p>#2에서 Workqueue는 생성된 Thread를 Event 수신자로서 동작하는것이 가능하다고 하였다. 
이는 자신이 파일에서 직접 Data를 읽지 않고 외부로 부터 Event로 Data를 수신할 수 있다는 말이된다. 
그렇기에 각 출력장치에 대응하는 1:1의 Thread를 생성한다.
<img src="../images/match.png" alt="match" /></p>

<blockquote>
  <p>Thread Stack 생성된 출력장치의 Meta data관리?</p>
</blockquote>

<p>우리가 프로그래밍을 하다보면 이론적으로 ‘캡슐화’라는 용어를 접하게 된다. 
“‘캡슐화’는 필요한 속성 또는 행위를 하나로 묶고 외부에서 사용하지 못하도록 은닉한다. “
로 의미를 해석할 수 있다. 
캡슐화를 하지 않고 전역적으로 사용되는 속성들이 늘어나면 Module의 개념을 잃어버리게 되고,
 필요한 동작과 전혀 관계없는 코드에서도 모두 참조가 가능하므로, 뒤죽박죽 섞인, 나아가선 전혀 관리 할 수 없는 코드가 될것이다.
 또한 System의 Static한 Resource들은 자신만의 속성( Meta data)을 가지고 있기 때문에 여러 Thread또는 전역적으로 참조가 가능해지면,
 System에 예기치 못한 상황을 발생 시킬수 있다.</p>

<p>그럼 이제 위의 캡슐화 내용을 충족시키기 위한 방법으로 Thread의 Stack에 Meta Data를 생성하자. 
 Thread Stack에 생성된 Meta Data는 강제로  Pointer로 엮지 않는이상 외부로 노출될 수 없고, 해당 Thread 내에서 모든 처리가 가능해지기 때문에 
 Module의 의미를 가질 수 있다.</p>

<p>“그럼 다른 곳에서 Meta Data가 필요해 지면 어떻게 할 것인가?” 이와 같은 질문이 생길수 있다. 
 Meta Data는 그 Resource에 대한 동작을 수행하기위한 내용들이기 때문에 수행해줄 어떠한 Module만 있다면 
 내가 그 Meta Data를 직접 참조하지 않아도 되며, 단지 요청만 하면되는 것이다.
 <img src="../images/request.png" alt="request" /></p>

<blockquote>
  <p>파일Instance를 2개의 Thread에서 접근한다?</p>
</blockquote>

<p>file 또한 System에 존재하는 유일한 Resource로 볼 수 있다. 
위에서 이미 유일한 Resource에 대한 접근 방법을 설명하였다. 
그렇다면 파일에 대한 Module(Thread) 를 생성해야 하는 것인가?
물론 별도로 만들어도 큰 문제는 발생하지 않는다. 
다만 우리에겐 이미 main thread가 생성되어 있으므로 재생 요청자를 main thread로 설정하자
<img src="../images/main_request.png" alt="main_request" /></p>

<blockquote>
  <p>Thread BusyLock?</p>
</blockquote>

<p>#2에서 “수신자는 EventQueue를 감시함에 있어서 Cpu자원을 소비하지 않는다.”
처럼 Workqueue는 다른 Thread의 동작에 영향을 주지 않는다.</p>

<blockquote>
  <p>출력장치와의 Interface?</p>
</blockquote>

<p>지금까진 MainThread에서 출력 Thread로 재생을요청하는 Interface만 존재한다. 
출력장치라는건 Output에 대한 Spec이 변경될 수도 있고 때론 System의 문제로 출력을 할 수 없는 상황 이 발생할 수 있다. 
한 예로  더이상 출력하지 못한 상황이 발생한다면, 더이상 MainThread로 부터 재생을 요청하는 Event를 수신 하지 않아도 될것이다. 
그렇다면 어떻게 Event를 수신 하지 않도록 변경할 수 있을까?</p>

<p>#2에서 Workqueue는 요청자임과 동시에 수신자가 될 수 있음을 설명하였다. 
지금까지 수신자 역할만 해오던 출력장치Thread에 요청자 기능을 추가하고 요청기능만 수행하던 MainThread에 수신기능을 추가하면
위 내용을 모두 만족한다.
<img src="../images/com.png" alt="com" /></p>

<h3 id="이제-위의-구조설계를-코드로-표현해보자">이제 위의 구조설계를 코드로 표현해보자</h3>
<center>Main.cpp</center>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++">    <span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="cm">/*MainThread's Meta data 생성*/</span>		
     <span class="cm">/*출력할 오디오 파일 Open */</span>		
     <span class="n">open_file</span><span class="p">();</span>                                            
     <span class="cm">/*출력 Thread 생성*/</span>		 
     <span class="n">output_thread_audio1_start</span><span class="p">();</span>
     <span class="n">output_thread_audio2_start</span><span class="p">();</span>
		 
    <span class="cm">/*Main Loop*/</span>
     <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
     <span class="p">{</span>
      <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="cm">/*Event 수신대기(여기서 "timeout"을 0으로 설정하였기 때문에 Event 발생까지
           Block되지 않고 Event수신 여부만 확인하고 바로 Return)*/</span>
      <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">workqueue_recv</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">timeout_occur</span><span class="p">)</span>
      <span class="p">{</span>
       <span class="cm">/*수신된 Event가 없는경우 Data를 얻어옴*/</span>			
       <span class="n">data</span><span class="o">=</span><span class="n">read_file</span><span class="p">();</span>
      <span class="cm">/*읽어온 Data를 출력Thread로 전송*/</span>
       <span class="n">workqueue_send</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
       <span class="n">workqueue_send</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">has_event</span><span class="p">)</span>
      <span class="p">{</span>
       <span class="cm">/*수신된 Event가 존재하는경우 MainLoop종료*/</span>
       <span class="n">output_thread_audio1_stop</span><span class="p">();</span>
       <span class="n">output_thread_audio2_stop</span><span class="p">();</span>
       <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
     <span class="p">}</span>
    <span class="p">}</span></code></pre></figure>

<p>위 코드에서 핵심은 “workqueue_recv(timeout)”와 “workqueue_send(data)”이다. 
“workqueue_recv(timeout)”를 통해 수신자 역할을 하고, “workqueue_send(data)”를 통해 요청자 역할을 동시에 사용함으로써
생성한 출력 Thread와 Communication을 수행하고있음을 볼 수 있다. 
Event 수신 대기시(“workqueue_recv(timeout)”)에 Timeout을 지정하지 않음으로써 Block되지 않고 단순 Event발생 여부만 확인하며,
특별히 처리할 Event가 없는경우 자신의 본 역할, 파일에서 Data를 읽어 “workqueue_send(data)”를 통해 출력 Thread로 Event를 요청하고
발생한 Event가 있는경우 그 요청에 대한 내용을 수행하는 모습을 볼 수 있다.</p>

<center>Output_Thread_Audio.cpp</center>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++">    <span class="kt">void</span> <span class="nf">thread_start_routine</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="cm">/*Metadata 생성*/</span>		
     <span class="n">open_audio</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>     
     <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>		 
    <span class="p">{</span>
       <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">infinite</span><span class="p">;</span>
      <span class="cm">/*Event 수신대기(Timeout을 infinite로 설정하였기때문에,
          MainThread의 Event요청이 있을시까지 무한대기)*/</span>
      <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">workqueue_recv</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">has_event</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="cm">/*Event 수신시 오디오 장치로 Data 쓰기*/</span>			
        <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">write_audio</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>			
        <span class="cm">/*오디오 장치의 결과를 확인하고 오류 발생시, 종료요청*/</span>
       <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span><span class="n">workqueue_send</span><span class="p">(</span><span class="n">close</span><span class="p">);</span>
      <span class="p">}</span>						
     <span class="p">}</span>     
    <span class="p">}</span></code></pre></figure>

<p>Main Thread의 코드 흐름과 크게 차이점이 없다.
여기서도 “workqueue_recv(timeout)”, “workqueue_send(data)”를 통해 요청/수신역할을 모두 수행하며,
단지 Event발생시 자신의 역할인오디오장치로 Data를 내보내며, 내보낸 결과가 오류를 반환하면 Main으로 종료를 요청하게된다.</p>

<h2 id="4-as-i-finished">#4 As I Finished…</h2>
<p>지금까지 #1에서 Thread의 필요성 #2에서 Workqueue 이론 #3에선 #1과 #2를 조합한 구조설계 방향을 알아보았다.</p>

<p>내가 이 Workqueue라는 기능을 만들어 사용하고 있는 이유는,  개발하면서 항상 생각하게되는 Module 코드 작성,</p>

<p>Thread 비용감소 측면과 프로그램의 기반을 두기 위함이다.</p>

<p>어떤 Project를 진행할때, 단순 Output만이 아닌 그 프로그램의 명확한 구조설계, 이를 바탕으로한  Framework를 가져가는것이</p>

<p>코드작성의 목적이 확실해지고, 동작 오류를 최소화하며 나아가 완료된 Project의 유지보수에 소요되는 시간을 줄여나갈수있다.</p>

<p>물론 Workqueue라는 것이 Framework라는 큰 범주를 뜻하는 것은 아니다.</p>

<p>다만 살을 덧붙여 Pooling, Observer등 큰 패턴을 그려낼수 있고, 구조설계에 있어 여러 시각으로 바라 볼 수 있게하는 기회를 제공해 주기에</p>

<p>활용성이 충분한 기능이라 생각한다.</p>

<h4 id="자-그럼-이제-위-내용들을-실제-코드로-적용할수-있는-library를-보러가자">자, 그럼 이제 위 내용들을 실제 코드로 적용할수 있는 Library를 보러가자.</h4>

<p><a href="https://whois-hm.github.io/workqueue-api">workqueue_api</a></p>

            </article>

            <!--
<section class="share">
    <h3>Share</h3>
    <a aria-label="Share on Twitter" href="https://twitter.com/intent/tweet?text=&quot;&quot;%20http://localhost:4000/about-workqueue/%20via%20&#64;&hashtags="
    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">
        <svg class="icon icon-twitter"><use xlink:href="#icon-twitter"></use></svg>
    </a>
    <a aria-label="Share on Facebook"href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/about-workqueue/"
    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">
        <svg class="icon icon-facebook"><use xlink:href="#icon-facebook"></use></svg>
    </a>
    <a aria-label="Share on Google Plus" href="https://plus.google.com/share?url=http://localhost:4000/about-workqueue/"
    onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" title="Share on Google+">
        <svg class="icon icon-google-plus"><use xlink:href="#icon-google-plus"></use></svg>
    </a>
</section>
-->
            <!--
<section class="author" itemprop="author">
    <div class="details" itemscope itemtype="http://schema.org/Person">
        <img itemprop="image" class="img-rounded" src="/assets/img/blog-author.jpg" alt="">
        <p class="def">Author</p>
        <h3 class="name">
            <a itemprop="name" href="https://plus.google.com/+/posts">hmkwon</a>
        </h3>
        <p class="desc">^_^</p>
        <p><a itemprop="email" class="email" href="mailto:khm767@gmail.com">khm767@gmail.com</a></p>
        <p><a itemprop="github" class="github" href="https://github.com/">github.com/</a></p>
    </div>
</section>
-->

             
                <!--
<section class="comments">
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
</section>
<script type="text/javascript">
    var disqus_loaded = false;

    function load_disqus()
    {
        disqus_loaded = true;
        var disqus_shortname = '';
        var disqus_title = '';
        var disqus_url = '/about-workqueue/';
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        var ldr = document.getElementById('disqus_loader');
    };
    window.onscroll = function(e) {
        if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 800)) {
            //hit bottom of page
            if (disqus_loaded==false)
                load_disqus()
        }
    };
</script>
-->

            
            <footer>
    <p></a></p>
</footer>
<script src="/assets/js/main.js"></script>
        </section>
    </body>
</html>
